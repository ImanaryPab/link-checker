# Веб-сервер для проверки доступности ссылок (Link Checker)

## Описание

Сервис предоставляет REST API для асинхронной проверки доступности веб-ресурсов. Пользователи могут отправлять списки ссылок, получать статус их проверки и формировать PDF-отчеты по результатам. Сервис спроектирован с учетом устойчивости — сохраняет свое состояние на диск и корректно восстанавливает его после перезапуска.

## Ключевые возможности

-   **Асинхронная проверка ссылок**: Отправка списка URL и немедленное получение номера задачи. Реальная проверка происходит в фоновом режиме.
-   **Сохранение истории**: Все задачи и их результаты сохраняются в локальном файле.
-   **Устойчивость к перезапускам** (State Persistence): При остановке или перезагрузке сервера все данные автоматически восстанавливаются из файла `state/storage.json`.
-   **Генерация отчетов**: Формирование PDF-файла с результатами проверки по запрошенным номерам задач.
-   **Graceful Shutdown**: Корректная обработка сигналов остановки (SIGINT, SIGTERM) с сохранением текущего состояния.

## Архитектура и используемые паттерны

Проект реализован с чистым разделением ответственности (Separation of Concerns):

1.  **`internal/handler`** (Transport Layer): Обработка HTTP-запросов и валидация входящих данных.
2.  **`internal/storage`** (Repository Layer): Управление состоянием приложения. Реализует потокобезопасное хранилище (`sync.RWMutex`) с сериализацией в JSON.
3.  **`internal/checker`** (Service Layer): Бизнес-логика проверки доступности ссылок. Использует пул HTTP-клиентов и конкурентную обработку через горутины.
4.  **`internal/pdf`** (Service Layer): Логика формирования структурированного PDF-документа с результатами.

**Основные паттерны**:
-   **Repository Pattern**: Для абстракции работы с данными (хранилищем задач).
-   **Dependency Injection**: Компоненты (`Storage`, `Checker`) явно передаются в зависимости через конструкторы.
-   **Graceful Shutdown**: Обеспечивает завершение работы без потери данных.
-   **Worker Pool (Goroutine-based)**: Для эффективной параллельной проверки множества ссылок.

## Быстрый старт

### Предварительные требования
- Установленный [Go](https://go.dev/dl/) версии 1.21 или выше.

### Установка и запуск

1.  **Клонируйте и подготовьте проект**
    ```bash
    mkdir link-checker && cd link-checker
    go mod init link-checker
    go mod tidy
    mkdir -p internal/{handler,storage,checker,pdf} state
    ```
2.  **Создайте файлы проекта**
    Скопируйте код из предоставленных файлов (`main.go`, `internal/handler/handler.go`, `internal/storage/storage.go`, `internal/checker/checker.go`, `internal/pdf/pdf.go`) в соответствующие директории.
3.  **Запустите сервер**
    ```bash
    go run main.go
    ```
    Сервис будет доступен по адресу `http://localhost:8080`.

## API Endpoints

### 1. `POST /api/check` — Проверить список ссылок
Принимает JSON со списком URL, создает задачу на проверку и немедленно возвращает ее номер.

**Запрос:**
```bash
curl -X POST http://localhost:8080/api/check \
  -H "Content-Type: application/json" \
  -d '{"links": ["google.com", "yandex.ru", "nonexistent-domain-12345.test"]}'
```
**Ответ (202 Accepted):**
```json
{
  "links": {
    "google.com": "processing",
    "yandex.ru": "processing",
    "nonexistent-domain-12345.test": "processing"
  },
  "links_num": 1
}
```

### 2. `GET /api/status/{id}` — Получить статус задачи
Возвращает актуальные результаты проверки для указанного номера задачи.

**Запрос:**
```bash
curl http://localhost:8080/api/status/1
```
**Ответ (200 OK):**
```json
{
  "links": {
    "google.com": "available",
    "yandex.ru": "available",
    "nonexistent-domain-12345.test": "not available"
  },
  "links_num": 1
}
```
**Возможные статусы ссылки:** `"available"`, `"not available"`, `"processing"`, `"error"`.

### 3. `POST /api/report` — Сформировать PDF-отчет
Принимает список номеров задач и возвращает PDF-файл с консолидированными результатами.

**Запрос:**
```bash
curl -X POST http://localhost:8080/api/report \
  -H "Content-Type: application/json" \
  -d '{"links_list": [1, 2]}' \
  --output report.pdf
```

### 4. `GET /health` — Проверка работоспособности сервиса
Используется для мониторинга. Всегда возвращает `{"status":"ok"}`.

## Механизм сохранения состояния (State Persistence)

Одно из ключевых требований — сервис не должен терять задачи при перезагрузке. Это реализовано через **сериализацию состояния в JSON-файл**.

-   **Где хранится**: `./state/storage.json`
-   **Когда сохраняется**:
    1.  При создании новой задачи.
    2.  При обновлении статуса каждой ссылки в задаче.
    3.  **Важно**: При получении сигнала `SIGINT` или `SIGTERM` (Graceful Shutdown).
-   **Когда восстанавливается**: Автоматически при старте сервера (в функции `main()`).

Благодаря этому:
-   После перезапуска сервера все ранее созданные задачи (`links_num`) остаются доступны для запроса статуса или включения в отчет.
-   Задачи, которые находились в статусе `"processing"` на момент остановки, останутся в нем. Для их повторной проверки потребуется создать новую задачу.

## Graceful Shutdown

Сервер корректно обрабатывает запрос на остановку (Ctrl+C в терминале):
1.  **Прекращает прием** новых HTTP-соединений.
2.  **Позволяет завершиться** уже выполняющимся запросам (таймаут 30 сек).
3.  **Вызывает `store.SaveState()`** для гарантированного сохранения всех данных на диск.
4.  **Корректно завершает** работу процесса.

## Технические детали и ограничения

-   **Проверка доступности**: Для проверки используется HTTP-запрос типа `HEAD` с таймаутом 10 секунд. Ссылка считается доступной при коде ответа 2xx или 3xx.
-   **Автоматическое дополнение протокола**: Если в запросе ссылка указана без схемы (`http://` или `https://`), автоматически добавляется `https://`.
-   **Максимальное количество одновременных проверок**: Ограничено настройками HTTP-транспорта в `checker.go` (`MaxIdleConns`, `MaxIdleConnsPerHost`).
-   **Потокобезопасность**: Хранилище (`Storage`) использует `sync.RWMutex` для безопасного concurrent доступа из multiple горутин.


## Пример полного цикла работы

```bash
# 1. Запустить сервер
go run main.go

# 2. В другом терминале: Создать задачу на проверку
curl -X POST http://localhost:8080/api/check \
  -H "Content-Type: application/json" \
  -d '{"links": ["go.dev", "github.com"]}'

# 3. Получить номер задачи из ответа (например, 1) и запросить статус
curl http://localhost:8080/api/status/1

# 4. Сгенерировать отчет по задаче
curl -X POST http://localhost:8080/api/report \
  -H "Content-Type: application/json" \
  -d '{"links_list": [1]}' \
  -o my_report.pdf

# 5. Остановить сервер (Ctrl+C в первом терминале)
# 6. Запустить сервер снова и убедиться, что задача #1 все еще доступна
go run main.go
curl http://localhost:8080/api/status/1
```
